#!/bin/bash

# Main variables
ACCESS_KEY="{{ ROOT_USER }}"
SECRET_KEY="{{ ROOT_PASSWORD }}"

# URLs for MinIO endpoints
MINIO1_URL="http://{{ hostvars[groups['minio-servers'][0]].ansible_host }}:9000"
MINIO2_URL="http://{{ hostvars[groups['minio-servers'][1]].ansible_host }}:9000"

# List of buckets to create
BUCKETS={{ MINIO_BUCKETS }}

# Helper function to check for errors and exit if a command fails
check_command() {
  if [ $? -ne 0 ]; then
    echo "Error: $1 failed."
    exit 1
  else
    echo "$1 succeeded."
  fi
}

# Function to set an alias for MinIO
set_minio_alias() {
  local alias_name=$1
  local url=$2
  local access_key=$3
  local secret_key=$4

  echo "Setting alias for $alias_name..."
  mc alias set "$alias_name" "$url" "$access_key" "$secret_key"
  check_command "Alias set for $alias_name"
}

# Function to create a bucket
create_bucket() {
  local alias_name=$1
  local bucket_name=$2

  echo "Creating bucket $bucket_name on $alias_name..."
  mc mb "$alias_name/$bucket_name"
  check_command "Bucket creation for $bucket_name"
}

# Set aliases for minio1 and minio2
set_minio_alias "minio1" "$MINIO1_URL" "$ACCESS_KEY" "$SECRET_KEY"
set_minio_alias "minio2" "$MINIO2_URL" "$ACCESS_KEY" "$SECRET_KEY"

# Create the buckets on minio1 using a for loop
for bucket in "${BUCKETS[@]}"; do
  create_bucket "minio1" "$bucket"
done

# Set up replication from minio1 to minio2
mc admin replicate add minio1 minio2

echo "All tasks completed successfully."
